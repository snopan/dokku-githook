#!/usr/bin/env bash

declare PLUGIN_PATH="$PLUGIN_AVAILABLE_PATH/github-hook"
source "$PLUGIN_PATH/utils"

installGo() {
	wget https://dl.google.com/go/go1.17.5.linux-amd64.tar.gz
	tar -xzf go1.17.2.linux-amd64.tar.gz
	rm go1.17.2.linux-amd64.tar.gz
	mv "./go" "$PLUGIN_PATH/"
}

# Check for defined env before continuing
checkGithubHookPort
checkLocalControlPort
checkGithubAuth

# Install golang binaries
installGo

# Install other dependencies
apt update
apt install ufw -y

# Login to dokku github
dokku git:auth github.com $GITHUB_USERNAME $GITHUB_TOKEN

# Port foward the github hook port
ufw allow $GITHUB_HOOK_PORT

# Create all storage files
mkdir "$PLUGIN_PATH/data"
echo -n > "$PLUGIN_PATH/data/hooks"
echo -n > "$PLUGIN_PATH/data/deploys"
echo -n > "$PLUGIN_PATH/data/links"

# Define the systemd service
read -r -d '' GITHUB_HOOK_SERVICE <<EOF
[Unit]
Description=Github hook service that listens for hook request and deploys dokku apps
ConditionPathExists=$PLUGIN_PATH/main.go
After=network.target

[Service]
Type=simple
User=dokku
Group=dokku
LimitNOFILE=1024
Environment="GITHUB_HOOK_PORT=$GITHUB_HOOK_PORT" "LOCAL_CONTROL_PORT=$LOCAL_CONTROL_PORT"

WorkingDirectory=$PLUGIN_PATH
ExecStart="$PLUGIN_PATH/start.sh"
StandardOutput=journal
StandardError=journal
SyslogIdentifier=github-hook-service

[Install]
WantedBy=multi-user.target
EOF

# Write the systemd service to file
echo "$GITHUB_HOOK_SERVICE" > /etc/systemd/system/github-hook.service 

# Enable the service
systemctl daemon-reload
systemctl start github-hook.service
